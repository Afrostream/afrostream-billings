<?php

require_once("../libs/providers/orange/client/idpMetadata.php");

function checkSimpleSignature($params, $cert) {
     $samlResponse = @base64_decode( $params['SAMLResponse'] );
     $signature = @base64_decode($params['Signature']);
     $sigAlg = $params['SigAlg'];
     if ((strcmp($sigAlg, "http://www.w3.org/2000/09/xmldsig#dsa-sha1") != 0) && 
          (strcmp($sigAlg, "http://www.w3.org/2000/09/xmldsig#rsa-sha1") != 0)) { 
        throw new Exception("Signature algorithm ".$sigAlg." is not supported"); 
     }
     if ( isset($params['RelayState'] ) ) {
	 $signedData = "SAMLResponse=".$samlResponse.
			"&RelayState=".$params['RelayState']."&SigAlg=".$sigAlg;
     } else {
	 $signedData = "SAMLResponse=".$samlResponse."&SigAlg=".$sigAlg;
     }
     return (@openssl_verify($signedData, $signature, $cert));
}


# Decode the Response
$encodedAuthnResponse = 
//"PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9Il9tRmNpc1FnQmI2RzZIczZ3dFNhIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAxNi0wNC0yNVQxNDoyMjowOVoiIERlc3RpbmF0aW9uPSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgSW5SZXNwb25zZVRvPSJfYmZlMTNhZjA3YzFlYzkyY2NjOTBlM2VmYWRiNDFjZGMiPjxJc3N1ZXIgeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdGF0dXM+PFN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvU3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfeHU5cnhIU3BqQUxyWUhpM1VNQSIgVmVyc2lvbj0iMi4wIiBJc3N1ZUluc3RhbnQ9IjIwMTYtMDQtMjVUMTQ6MjI6MDlaIj48SXNzdWVyPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdWJqZWN0PjxOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDpwZXJzaXN0ZW50Ij5TVk9BRlItMjAwLWI3bUc2ZW1WQ3l6MHdLREdPbDJoSGVTMFlXdjFHeEhvY2dDb3VNNDRacXM9PC9OYW1lSUQ+PFN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgUmVjaXBpZW50PSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgTm90T25PckFmdGVyPSIyMDE2LTA0LTI1VDE0OjM3OjA5WiIgSW5SZXNwb25zZVRvPSJfYmZlMTNhZjA3YzFlYzkyY2NjOTBlM2VmYWRiNDFjZGMiLz48L1N1YmplY3RDb25maXJtYXRpb24+PC9TdWJqZWN0PjxDb25kaXRpb25zPjxBdWRpZW5jZVJlc3RyaWN0aW9uPjxBdWRpZW5jZT5TVk9BRlJBMTlBMzNGNzg4RkNFNDwvQXVkaWVuY2U+PC9BdWRpZW5jZVJlc3RyaWN0aW9uPjwvQ29uZGl0aW9ucz48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDE2LTA0LTI1VDE0OjIyOjA5WiI+PEF1dGhuQ29udGV4dD48QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9yYW5nZTphdXRoOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRDb29raWVCYXNlZDwvQXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9BdXRobkNvbnRleHQ+PC9BdXRoblN0YXRlbWVudD48QXR0cmlidXRlU3RhdGVtZW50PjxBdHRyaWJ1dGUgTmFtZT0iT3JhbmdlQVBJVG9rZW4iIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm9maWxlczphdHRyaWJ1dGU6YmFzaWMiPjxBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5CNjRQc3VxRTdxQ1dVNndmS1Q0WHVJZS9DWmwxQnRFQlNzV25MbEQ5V2hycEExWHd3R0N0LzlWTzRQZzA3RFZlRlhIWjFJN3JPYnBqK01ybEhKdkZlZW13L2crODRoZXFhNittalp5MjZvdW1naz18TUNPPU9GUnxzYXU9M3x0ZWQ9MTQ2Njg2NDUyOXx0Y2Q9MTQ2MTU5NDEyOXxhR2NPMjJCMXhtMERKc0ZqejI2dUs3Qk9YeG89PC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48L0Fzc2VydGlvbj48L1Jlc3BvbnNlPgo=";//$_POST['SAMLResponse'];
"PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9Il9HcDlVMU5FSVd1cnU1cXpzUW5XIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAxNi0wNC0yN1QwOTowOTo1MFoiIERlc3RpbmF0aW9uPSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgSW5SZXNwb25zZVRvPSJfMWMxZjMzZDlkMGZhMjEzOGMxODcyNmMxNDdjNjgxMmEiPjxJc3N1ZXIgeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdGF0dXM+PFN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvU3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfelRFamVaMmpxQUhqYzRvODJISyIgVmVyc2lvbj0iMi4wIiBJc3N1ZUluc3RhbnQ9IjIwMTYtMDQtMjdUMDk6MDk6NTBaIj48SXNzdWVyPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdWJqZWN0PjxOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDpwZXJzaXN0ZW50Ij5TVk9BRlItMjAwLWI3bUc2ZW1WQ3l6MHdLREdPbDJoSGVTMFlXdjFHeEhvY2dDb3VNNDRacXM9PC9OYW1lSUQ+PFN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgUmVjaXBpZW50PSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgTm90T25PckFmdGVyPSIyMDE2LTA0LTI3VDA5OjI0OjUwWiIgSW5SZXNwb25zZVRvPSJfMWMxZjMzZDlkMGZhMjEzOGMxODcyNmMxNDdjNjgxMmEiLz48L1N1YmplY3RDb25maXJtYXRpb24+PC9TdWJqZWN0PjxDb25kaXRpb25zPjxBdWRpZW5jZVJlc3RyaWN0aW9uPjxBdWRpZW5jZT5TVk9BRlJBMTlBMzNGNzg4RkNFNDwvQXVkaWVuY2U+PC9BdWRpZW5jZVJlc3RyaWN0aW9uPjwvQ29uZGl0aW9ucz48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDE2LTA0LTI3VDA5OjA5OjUwWiI+PEF1dGhuQ29udGV4dD48QXV0aG5Db250ZXh0Q2xhc3NSZWY+dXJuOm9yYW5nZTphdXRoOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRDb29raWVCYXNlZDwvQXV0aG5Db250ZXh0Q2xhc3NSZWY+PC9BdXRobkNvbnRleHQ+PC9BdXRoblN0YXRlbWVudD48QXR0cmlidXRlU3RhdGVtZW50PjxBdHRyaWJ1dGUgTmFtZT0iT3JhbmdlQVBJVG9rZW4iIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm9maWxlczphdHRyaWJ1dGU6YmFzaWMiPjxBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5CNjQwM3k3SEFUbU15cXNQdDcwektwazljMmE4UkhJMFBJbmRFSCt5MXpubmQzUFFuaTl6L1FLR1IwWXVQaFBjc0hPSjJXaytMSnY0T3RNV2RNRW41Ui9PWXdMTG1DOHdpVWFuMUJ4Q0I0VCtyST18TUNPPU9GUnxzYXU9M3x0ZWQ9MTQ2NzAxODU5MHx0Y2Q9MTQ2MTc0ODE5MHxzOTkwYk1qMzdWbWdNaXBzTnFNRGZrUDNzcUE9PC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48L0Fzc2VydGlvbj48L1Jlc3BvbnNlPgo=";
$authnResponse = @base64_decode($encodedAuthnResponse);

# Get some useful data from XML
$xml = simplexml_load_string($authnResponse);
$status = (string)$xml->{'Status'}->{'StatusCode'}['Value'];
if ($status != "urn:oasis:names:tc:SAML:2.0:status:Success") {
     // Can be internal error, authentication failure, …
     //  or the user refused when consent was asked ?
     throw new Exception("Status is not success : ".
				(string)$xml->{'Status'}->{'StatusMessage'});
}
// Technical identifier of the IDP
$idpProvider = (string)$xml->{'Assertion'}->{'Issuer'};
// Federation NameIdentifier to be used as a key to identify the user on SP side
$nameID = (string)$xml->{'Assertion'}->{'Subject'}->{'NameID'};
// Authentication context
$authnContext = (string)$xml->{'Assertion'}->{'AuthnStatement'}->{'AuthnContext'}->{'AuthnContextClassRef'};
// Validity date of the assertion (to be checked by the SP)
$notOnOrAfter = (string)$xml->{'Assertion'}->{'Subject'}->{'SubjectConfirmation'}->{'SubjectConfirmationData'}['NotOnOrAfter'];
$recipient = (string)$xml->{'Assertion'}->{'Subject'}->{'SubjectConfirmation'}->{'SubjectConfirmationData'}['Recipient'];
$audience = (string)$xml->{'Assertion'}->{'Conditions'}->{'AudienceRestriction'}->{'Audience'};

# Verification of signature
$ret = checkSimpleSignature(
//$_POST, 
//"SAMLResponse=PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9Il9tRmNpc1FnQmI2RzZIczZ3dFNhIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAxNi0wNC0yNVQxNDoyMjowOVoiIERlc3RpbmF0aW9uPSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgSW5SZXNwb25zZVRvPSJfYmZlMTNhZjA3YzFlYzkyY2NjOTBlM2VmYWRiNDFjZGMiPjxJc3N1ZXIgeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdGF0dXM%2BPFN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvU3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfeHU5cnhIU3BqQUxyWUhpM1VNQSIgVmVyc2lvbj0iMi4wIiBJc3N1ZUluc3RhbnQ9IjIwMTYtMDQtMjVUMTQ6MjI6MDlaIj48SXNzdWVyPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdWJqZWN0PjxOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDpwZXJzaXN0ZW50Ij5TVk9BRlItMjAwLWI3bUc2ZW1WQ3l6MHdLREdPbDJoSGVTMFlXdjFHeEhvY2dDb3VNNDRacXM9PC9OYW1lSUQ%2BPFN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgUmVjaXBpZW50PSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgTm90T25PckFmdGVyPSIyMDE2LTA0LTI1VDE0OjM3OjA5WiIgSW5SZXNwb25zZVRvPSJfYmZlMTNhZjA3YzFlYzkyY2NjOTBlM2VmYWRiNDFjZGMiLz48L1N1YmplY3RDb25maXJtYXRpb24%2BPC9TdWJqZWN0PjxDb25kaXRpb25zPjxBdWRpZW5jZVJlc3RyaWN0aW9uPjxBdWRpZW5jZT5TVk9BRlJBMTlBMzNGNzg4RkNFNDwvQXVkaWVuY2U%2BPC9BdWRpZW5jZVJlc3RyaWN0aW9uPjwvQ29uZGl0aW9ucz48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDE2LTA0LTI1VDE0OjIyOjA5WiI%2BPEF1dGhuQ29udGV4dD48QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9yYW5nZTphdXRoOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRDb29raWVCYXNlZDwvQXV0aG5Db250ZXh0Q2xhc3NSZWY%2BPC9BdXRobkNvbnRleHQ%2BPC9BdXRoblN0YXRlbWVudD48QXR0cmlidXRlU3RhdGVtZW50PjxBdHRyaWJ1dGUgTmFtZT0iT3JhbmdlQVBJVG9rZW4iIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm9maWxlczphdHRyaWJ1dGU6YmFzaWMiPjxBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5CNjRQc3VxRTdxQ1dVNndmS1Q0WHVJZS9DWmwxQnRFQlNzV25MbEQ5V2hycEExWHd3R0N0LzlWTzRQZzA3RFZlRlhIWjFJN3JPYnBqK01ybEhKdkZlZW13L2crODRoZXFhNittalp5MjZvdW1naz18TUNPPU9GUnxzYXU9M3x0ZWQ9MTQ2Njg2NDUyOXx0Y2Q9MTQ2MTU5NDEyOXxhR2NPMjJCMXhtMERKc0ZqejI2dUs3Qk9YeG89PC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48L0Fzc2VydGlvbj48L1Jlc3BvbnNlPgo%3D&SigAlg=http%3A%2F%2Fwww.w3.org%2F2000%2F09%2Fxmldsig%23rsa-sha1&Signature=E1xLVBGcCJhCJAnQxBGOVBSjdID%2BdbeVSRpwBZUO0tC8NRN%2BoEaQf390%2FsAiQDvc8wbQk5RA0zlwFathCF%2BvIr4EjvYLsz3yuv7MjyaVbaXI9fp0z4Ki3EcQ%2FwSZq%2FU6%2FMAA82Wt6jq5SZOHEMXqC79nMXr9bHLpCDfvqUIwHEA%3D",
"SAMLResponse=PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPFJlc3BvbnNlIHhtbG5zPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6cHJvdG9jb2wiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIHhtbG5zOnhzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgSUQ9Il9HcDlVMU5FSVd1cnU1cXpzUW5XIiBWZXJzaW9uPSIyLjAiIElzc3VlSW5zdGFudD0iMjAxNi0wNC0yN1QwOTowOTo1MFoiIERlc3RpbmF0aW9uPSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgSW5SZXNwb25zZVRvPSJfMWMxZjMzZDlkMGZhMjEzOGMxODcyNmMxNDdjNjgxMmEiPjxJc3N1ZXIgeG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdGF0dXM%2BPFN0YXR1c0NvZGUgVmFsdWU9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpzdGF0dXM6U3VjY2VzcyIvPjwvU3RhdHVzPjxBc3NlcnRpb24geG1sbnM9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDphc3NlcnRpb24iIElEPSJfelRFamVaMmpxQUhqYzRvODJISyIgVmVyc2lvbj0iMi4wIiBJc3N1ZUluc3RhbnQ9IjIwMTYtMDQtMjdUMDk6MDk6NTBaIj48SXNzdWVyPmh0dHA6Ly9vdHZwLmF1dGgtaW50Lm9yYW5nZS5mcjwvSXNzdWVyPjxTdWJqZWN0PjxOYW1lSUQgRm9ybWF0PSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6bmFtZWlkLWZvcm1hdDpwZXJzaXN0ZW50Ij5TVk9BRlItMjAwLWI3bUc2ZW1WQ3l6MHdLREdPbDJoSGVTMFlXdjFHeEhvY2dDb3VNNDRacXM9PC9OYW1lSUQ%2BPFN1YmplY3RDb25maXJtYXRpb24gTWV0aG9kPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6Y206YmVhcmVyIj48U3ViamVjdENvbmZpcm1hdGlvbkRhdGEgUmVjaXBpZW50PSJodHRwczovL3N0YWdpbmcuYWZyb3N0cmVhbS50di9hdXRoL29yYW5nZS9jYWxsYmFjayIgTm90T25PckFmdGVyPSIyMDE2LTA0LTI3VDA5OjI0OjUwWiIgSW5SZXNwb25zZVRvPSJfMWMxZjMzZDlkMGZhMjEzOGMxODcyNmMxNDdjNjgxMmEiLz48L1N1YmplY3RDb25maXJtYXRpb24%2BPC9TdWJqZWN0PjxDb25kaXRpb25zPjxBdWRpZW5jZVJlc3RyaWN0aW9uPjxBdWRpZW5jZT5TVk9BRlJBMTlBMzNGNzg4RkNFNDwvQXVkaWVuY2U%2BPC9BdWRpZW5jZVJlc3RyaWN0aW9uPjwvQ29uZGl0aW9ucz48QXV0aG5TdGF0ZW1lbnQgQXV0aG5JbnN0YW50PSIyMDE2LTA0LTI3VDA5OjA5OjUwWiI%2BPEF1dGhuQ29udGV4dD48QXV0aG5Db250ZXh0Q2xhc3NSZWY%2BdXJuOm9yYW5nZTphdXRoOlNBTUw6Mi4wOmFjOmNsYXNzZXM6UGFzc3dvcmRDb29raWVCYXNlZDwvQXV0aG5Db250ZXh0Q2xhc3NSZWY%2BPC9BdXRobkNvbnRleHQ%2BPC9BdXRoblN0YXRlbWVudD48QXR0cmlidXRlU3RhdGVtZW50PjxBdHRyaWJ1dGUgTmFtZT0iT3JhbmdlQVBJVG9rZW4iIE5hbWVGb3JtYXQ9InVybjpvYXNpczpuYW1lczp0YzpTQU1MOjIuMDpwcm9maWxlczphdHRyaWJ1dGU6YmFzaWMiPjxBdHRyaWJ1dGVWYWx1ZSB4c2k6dHlwZT0ieHM6c3RyaW5nIj5CNjQwM3k3SEFUbU15cXNQdDcwektwazljMmE4UkhJMFBJbmRFSCt5MXpubmQzUFFuaTl6L1FLR1IwWXVQaFBjc0hPSjJXaytMSnY0T3RNV2RNRW41Ui9PWXdMTG1DOHdpVWFuMUJ4Q0I0VCtyST18TUNPPU9GUnxzYXU9M3x0ZWQ9MTQ2NzAxODU5MHx0Y2Q9MTQ2MTc0ODE5MHxzOTkwYk1qMzdWbWdNaXBzTnFNRGZrUDNzcUE9PC9BdHRyaWJ1dGVWYWx1ZT48L0F0dHJpYnV0ZT48L0F0dHJpYnV0ZVN0YXRlbWVudD48L0Fzc2VydGlvbj48L1Jlc3BvbnNlPgo%3D&SigAlg=http%3A%2F%2Fwww.w3.org%2F2000%2F09%2Fxmldsig%23rsa-sha1&Signature=jGRE5dSbX%2BcL0IlnPMYqwur4do821MZ1GyaJhCmuaxY99byJoXaXa02TH2LmrNFP%2Fan5z92keDQ5XfeAMrg7AAbVbsX%2F96L5VzylVgv4TmUZHEWoUH0eFWWbTjxaGYrSkgTpoEhyNgbQAF6XFFJA3hssRLF23SBzvIjIs49sIrE%3D",
$idpMetadata[$idpProvider]['certificate']);
if ($ret != 1) {
     throw new Exception("Signature is not valid");
}

# Verification of validity of the assertion
// Check the $notOnOrAfter parameter (date MUST not be passed)
if (gmdate('Y-m-d\TH:i:s\Z') > $notOnOrAfter){
     throw new Exception("Authentication failed: validy period expires");
}
// Check the $audience parameter (MUST be equal to the [SERVICE_ID])
if ($audience != "[SERVICE_ID]"){
     throw new Exception("Authentication failed: authencation token was not for [SERVICE_ID] but for " . $audience);
}
// Check the $recipient parameter (MUST be equal to the URL where this response is received)

# Profile attributes (only transmitted at first time access and if authorized by Orange)
$user_info = array();
if ($xml->{'Assertion'}->{'AttributeStatement'} &&
    $xml->{'Assertion'}->{'AttributeStatement'}->{'Attribute'}) {
    foreach ($xml->{'Assertion'}->{'AttributeStatement'}->{'Attribute'} as $attribute) {
	$key = $attribute['Name'];
	$user_info["$key"] = (string)$attribute->{'AttributeValue'};
    }
}

?>

<HTML>
<BODY>
	Signature : 	<?php echo $ret ?> <BR>
	Status : 	<?php echo $status ?> <BR>
	IDP :		<?php echo $idpProvider ?> <BR>
	NameID :	<?php echo $nameID ?> <BR>
	AuthnContext :	<?php echo $authnContext ?> <BR>
	NotOnOrAfter :	<?php echo $notOnOrAfter ?> <BR>
	Recipient : 	<?php echo $recipient ?> <BR>
	Audience : 	<?php echo $audience ?> <BR>
<BR>
	Attributes : 	<?php var_dump($user_info) ?>

</BODY> </HTML>